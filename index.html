<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor Empresarial - Escala BC</title>
  <style>
    /* Reset Básico */
    body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f4; }
    * { box-sizing: border-box; }

    /* --- Cabeçalho e Navegação (Azul Moderno) --- */
    header { background-color: #007bff; /* Azul Moderno */ color: white; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .nav-container { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: auto; }
    .logo { font-size: 1.5em; font-weight: bold; }
    
    /* Menu Principal */
    nav { display: flex; }
    nav > ul { list-style: none; padding: 0; margin: 0; display: flex; }
    nav > ul > li { position: relative; margin-left: 20px; }
    nav > ul > li > a { color: white; text-decoration: none; padding: 10px 0; display: block; cursor: pointer; }
    nav > ul > li:hover > a { background-color: #0056b3; } /* Efeito hover */

    /* Submenu */
    .submenu { display: none; position: absolute; top: 100%; left: 0; background-color: #0056b3; /* Azul mais escuro */ list-style: none; padding: 0; margin: 0; min-width: 180px; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .submenu li a { color: white; padding: 10px 15px; display: block; text-decoration: none; }
    .submenu li a:hover { background-color: #004085; }
    nav > ul > li:hover .submenu { display: block; }

    /* Menu Hamburguer (Mobile) */
    .menu-toggle { display: none; cursor: pointer; font-size: 24px; }

    /* --- Conteúdo Principal --- */
    .container { padding: 20px; max-width: 1200px; margin: auto; background-color: white; min-height: 80vh; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .content-section { display: none; padding: 20px 0; }
    .content-section.active { display: block; }

    /* --- Estilos de Formulário e Tabela --- */
    #cadastro-form-section form { max-width: 400px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
    #cadastro-form-section label { display: block; margin-top: 10px; font-weight: bold; }
    #cadastro-form-section input, #cadastro-form-section select, #cadastro-form-section button { width: 100%; margin: 5px 0; padding: 8px; box-sizing: border-box; }
    #cadastro-form-section button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    #cadastro-form-section button:hover { background-color: #45a049; }

    #visualizar-usuarios-section table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #visualizar-usuarios-section th, #visualizar-usuarios-section td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    #visualizar-usuarios-section th { background-color: #f2f2f2; }
    .action-btn { margin-right: 5px; padding: 5px 10px; cursor: pointer; border: none; border-radius: 3px; }
    .edit-btn { background-color: #2196F3; color: white; }
    .delete-btn { background-color: #f44336; color: white; }

    /* --- Estilos do Calendário --- */
    #escala-visualizar-section { text-align: center; }
    #escala-visualizar-section h3 { margin-bottom: 20px; color: #007bff; }
    .calendar-grid { display: flex; flex-wrap: wrap; border: 1px solid black; max-width: 100%; margin: auto; }
    .calendar-row { display: flex; width: 100%; }
    .calendar-cell { flex: 1; border: 1px solid black; padding: 5px; min-width: 100px; }
    
    .header-row .calendar-cell { background-color: black; color: white; font-weight: bold; }
    .header-row .calendar-cell .day-num { color: red; font-size: 1.1em; }
    
    .shift-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .shift-type { font-weight: bold; color: green; margin-bottom: 5px; }
    .user-select { width: 90%; padding: 3px; border: 1px solid #ccc; }

    /* --- Media Queries para Responsividade (Mobile) --- */
    @media (max-width: 768px) {
      .nav-container { flex-direction: column; align-items: flex-start; }
      .menu-toggle { display: block; position: absolute; right: 20px; top: 15px; }
      nav { width: 100%; }
      nav > ul { flex-direction: column; display: none; } /* Esconde o menu por padrão no mobile */
      nav > ul.active { display: flex; } /* Mostra o menu quando ativo */
      nav > ul > li { margin: 0; border-top: 1px solid #0056b3; }
      nav > ul > li > a { padding: 10px 15px; }
      
      .submenu { position: static; background-color: #004085; min-width: 100%; }
      .submenu li a { padding-left: 30px; }
      
      /* Responsividade do Calendário */
      .calendar-grid { display: block; }
      .calendar-row { border-bottom: 1px solid #ccc; margin-bottom: 10px; padding-bottom: 10px; }
      .calendar-cell { border: none; border-bottom: 1px dotted #ddd; }
    }
  </style>
</head>
<body>
  <header>
    <div class="nav-container">
      <div class="logo">Gestor BC</div>
      <div class="menu-toggle" id="menuToggle">&#9776;</div>
      <nav>
        <ul id="mainNav">
          <li>
            <a href="#">Cadastro</a>
            <ul class="submenu">
              <li><a href="#" data-target="cadastro-form-section">Usuários</a></li>
              <li><a href="#" data-target="visualizar-usuarios-section">Visualizar Usuários</a></li>
            </ul>
          </li>
          <li>
            <a href="#">Escala</a>
            <ul class="submenu">
              <li><a href="#" data-target="escala-criar-section">Criar</a></li>
              <li><a href="#" data-target="escala-visualizar-section">Visualizar</a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="container">
    
    <!-- SEÇÃO 1: CADASTRO DE USUÁRIOS -->
    <section id="cadastro-form-section" class="content-section active">
      <h2>Cadastro de Usuário</h2>
      <form id="cadastroForm">
        <label for="nome">Nome completo:</label>
        <input type="text" id="nome" name="nome" required>

        <label for="cpf">CPF:</label>
        <input type="text" id="cpf" name="cpf" required>

        <label for="login">Login:</label>
        <input type="text" id="login" name="login" required>

        <label for="senha">Senha:</label>
        <input type="password" id="senha" name="senha" required>

        <label for="tipo">Tipo:</label>
        <select id="tipo" name="tipo" required>
          <option value="Gestor">Gestor</option>
          <option value="Usuário">Usuário</option>
        </select>

        <button type="submit">Cadastrar</button>
      </form>
    </section>

    <!-- SEÇÃO 2: VISUALIZAR USUÁRIOS -->
    <section id="visualizar-usuarios-section" class="content-section">
      <h2>Usuários Cadastrados</h2>
      <table id="usersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>CPF</th>
            <th>Login</th>
            <th>Tipo</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dados serão inseridos aqui pelo JavaScript -->
        </tbody>
      </table>
    </section>
    
    <!-- SEÇÃO 3: CRIAR ESCALA -->
    <section id="escala-criar-section" class="content-section">
      <h2>Criar Escala</h2>
      <p>Funcionalidade de criação de escala será implementada aqui.</p>
    </section>
    
    <!-- SEÇÃO 4: VISUALIZAR ESCALA (Calendário) -->
    <section id="escala-visualizar-section" class="content-section">
      <h2>Visualizar Escala (Calendário)</h2>
      <div id="calendar-controls">
        <!-- Controles de Mês/Ano e Seleção de Calendário -->
      </div>
      <div id="calendar-view">
        <!-- O calendário será renderizado aqui -->
      </div>
    </section>

  </div>

  <script>
    // **ATENÇÃO**: Mantenha esta URL atualizada com a URL de implantação do seu Google Apps Script
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwXCtOBulNLVyiul3Ko-UEGUdMZOhX-yjbbm0Txl7i1dEP6zXubdlYh_tGiTExs4ZiRig/exec";
    
    const form = document.getElementById('cadastroForm' );
    const usersTableBody = document.querySelector('#usersTable tbody');
    const contentSections = document.querySelectorAll('.content-section');
    const menuToggle = document.getElementById('menuToggle');
    const mainNav = document.getElementById('mainNav');
    
    let editingUserId = null;
    let allUsersLogins = [];

    // --- 1. LÓGICA DO MENU E NAVEGAÇÃO ---
    
    menuToggle.addEventListener('click', () => {
        mainNav.classList.toggle('active');
    });

    function showSection(targetId) {
      contentSections.forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(targetId).classList.add('active');
      
      if (window.innerWidth <= 768) {
          mainNav.classList.remove('active');
      }
      
      if (targetId === 'visualizar-usuarios-section') {
        loadUsers();
      } else if (targetId === 'escala-visualizar-section') {
        loadCalendarUsers();
        renderCalendar();
      }
    }

    document.querySelectorAll('nav a[data-target]').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('data-target');
        showSection(targetId);
      });
    });

    // --- 2. CARREGAMENTO DE USUÁRIOS PARA O CALENDÁRIO ---
    async function loadCalendarUsers() {
        try {
            const response = await fetch(SCRIPT_URL);
            const users = await response.json();
            
            allUsersLogins = users
                .map(user => user.login)
                .sort((a, b) => a.localeCompare(b));
            
        } catch (err) {
            console.error('Erro ao carregar logins para o calendário:', err);
            allUsersLogins = [];
        }
    }

    // --- 3. ESTRUTURA BÁSICA DO CALENDÁRIO ---
    function renderCalendar() {
        const calendarView = document.getElementById('calendar-view');
        calendarView.innerHTML = '';
        
        const monthName = "JANEIRO DE 2025";
        const days = [
            { day: '01', weekday: 'seg' },
            { day: '02', weekday: 'ter' },
            { day: '03', weekday: 'qua' },
            { day: '04', weekday: 'qui' }
        ];
        
        let html = `<h3>${monthName}</h3>`;
        html += `<div class="calendar-grid">`;
        
        html += `<div class="calendar-row header-row">`;
        days.forEach(d => {
            html += `<div class="calendar-cell header-cell">
                        <span class="day-num">${d.day}</span> <span class="weekday">${d.weekday}</span>
                    </div>`;
        });
        html += `</div>`;
        
        for (let i = 0; i < 6; i++) {
            html += `<div class="calendar-row">`;
            days.forEach(d => {
                const shiftType = i < 3 ? 'Diurno' : 'Noturno';
                html += `<div class="calendar-cell shift-cell">
                            <span class="shift-type">${shiftType}</span>
                            <select class="user-select" data-day="${d.day}" data-shift="${shiftType}-${i}">
                                <option value="">Selecione</option>
                                ${allUsersLogins.map(login => `<option value="${login}">${login}</option>`).join('')}
                            </select>
                        </div>`;
            });
            html += `</div>`;
        }
        
        html += `</div>`;
        calendarView.innerHTML = html;
    }
    
    // --- 4. FUNÇÕES DE CRUD ---
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      const data = {
        id: editingUserId,
        nome: form.nome.value,
        cpf: form.cpf.value,
        login: form.login.value,
        senha: form.senha.value,
        tipo: form.tipo.value
      };
      
      const methodFunction = editingUserId ? 'doPut' : 'doPost';

      fetch(`${SCRIPT_URL}?action=${methodFunction}`, {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(response => {
        if (response.status === "ok") {
            alert(editingUserId ? "Usuário atualizado com sucesso!" : "Cadastro realizado com sucesso! ID: " + response.id);
            form.reset();
            editingUserId = null;
            form.querySelector('button[type="submit"]').textContent = 'Cadastrar';
            
            if (document.getElementById('visualizar-usuarios-section').classList.contains('active')) {
                loadUsers();
            }
        } else {
            alert("Erro: " + response.message);
        }
      })
      .catch(err => {
        console.error(err);
        alert("Erro ao enviar dados. Verifique o console para mais detalhes.");
      });
    });

    function loadUsers() {
      usersTableBody.innerHTML = '<tr><td colspan="6">Carregando usuários...</td></tr>';

      fetch(SCRIPT_URL)
        .then(res => res.json())
        .then(users => {
          usersTableBody.innerHTML = ''; 
          
          if (users.length === 0) {
            usersTableBody.innerHTML = '<tr><td colspan="6">Nenhum usuário cadastrado.</td></tr>';
            return;
          }

          users.forEach(user => {
            const row = usersTableBody.insertRow();
            
            row.insertCell().textContent = user.id || 'N/A';
            row.insertCell().textContent = user.nome || 'N/A';
            row.insertCell().textContent = user.cpf || 'N/A';
            row.insertCell().textContent = user.login || 'N/A';
            row.insertCell().textContent = user.tipo || 'N/A';
            
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `
              <button class="action-btn edit-btn" data-id="${user.id}" data-user='${JSON.stringify(user)}'>Editar</button>
              <button class="action-btn delete-btn" data-id="${user.id}">Excluir</button>
            `;
          });
          
          addActionListener();
        })
        .catch(err => {
          console.error('Erro ao carregar usuários:', err);
          usersTableBody.innerHTML = '<tr><td colspan="6">Erro ao carregar dados. Verifique o Apps Script.</td></tr>';
        });
    }
    
    function addActionListener() {
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', handleDelete);
        });
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', handleEdit);
        });
    }
    
    function handleDelete(e) {
        const id = e.target.getAttribute('data-id');
        if (!confirm(`Tem certeza que deseja excluir o usuário com ID ${id}?`)) {
            return;
        }
        
        fetch(`${SCRIPT_URL}?action=doDelete`, {
            method: "POST",
            body: JSON.stringify({ id: id })
        })
        .then(res => res.json())
        .then(response => {
            if (response.status === "ok") {
                alert(response.message);
                loadUsers();
            } else {
                alert("Erro ao excluir: " + response.message);
            }
        })
        .catch(err => {
            console.error('Erro ao excluir:', err);
            alert("Erro de comunicação ao tentar excluir.");
        });
    }
    
    function handleEdit(e) {
        const userData = JSON.parse(e.target.getAttribute('data-user'));
        
        form.nome.value = userData.nome;
        form.cpf.value = userData.cpf;
        form.login.value = userData.login;
        form.senha.value = userData.senha;
        form.tipo.value = userData.tipo;
        
        editingUserId = userData.id;
        form.querySelector('button[type="submit"]').textContent = 'Salvar Alterações';
        
        showSection('cadastro-form-section');
    }

    document.addEventListener('DOMContentLoaded', () => {
        showSection('cadastro-form-section');
    });
  </script>
</body>
</html>
